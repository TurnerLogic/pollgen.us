<html>
	<head>
		<title>Pollgeni.us</title

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="/css/bootstrap.min.css">

		<link rel="icon" href="../public/favicon.ico">
	</head>
	<body>
		<h1 id="pollTitle"></h1>
		<div id="pollContainer" class="container">
			<canvas id="pollResults" width="400" height="400"></canvas>
		</div>
		<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>

		<script src="/js/Chart.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script>

			var code = window.location.pathname.toString().split('/')[2];
			var socket = io('/' + code);
			var poll = null;
			var ctx = null;
			var chartData = [];
			var chartColors = ["#F7464A", "#ACBEA3", "#157A6E", "#499F68", "#68A357", "#FF33CC", "#444545", "#666699", "#32213A", "#40090D", "#E3D26F"];
			var ctx = $("#pollResults").get(0).getContext("2d");

  			var chartOptions = {
					    //Boolean - Whether we should show a stroke on each segment
					    segmentShowStroke : true,

					    //String - The colour of each segment stroke
					    segmentStrokeColor : "#fff",

					    //Number - The width of each segment stroke
					    segmentStrokeWidth : 2,

					    //Number - The percentage of the chart that we cut out of the middle
					    percentageInnerCutout : 50, // This is 0 for Pie charts

					    //Number - Amount of animation steps
					    animationSteps : 100,

					    //String - Animation easing effect
					    animationEasing : "easeOutBounce",

					    //Boolean - Whether we animate the rotation of the Doughnut
					    animateRotate : true,

					    //Boolean - Whether we animate scaling the Doughnut from the centre
					    animateScale : false,

					    //String - A legend template
					    legendTemplate : "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"

					};

			var myDoughnutChart = new Chart(ctx).Doughnut(chartData, chartOptions);

			var getJsonData = function(code)
			{
				var jsonResultsUrl = "/polls/" + code + "/json-results";

				$.get(jsonResultsUrl, function(data) {
					var pollData = formatPollData(data);
					$( '#pollTitle' ).text(data.question);

					pollData.forEach(function(element, index) {
						myDoughnutChart.addData(element);
					});

					myDoughnutChart.update();
				});
			}



			socket.on('poll submission', function(poll) {

				resetCanvas();
				myDoughnutChart = new Chart(ctx).Doughnut(chartData, chartOptions);
				console.log('poll submission');
				console.log(poll);

				var pollData = formatPollData(poll);

				pollData.forEach(function(element, index) {
					myDoughnutChart.addData(element);
				});


				myDoughnutChart.update();

			});

			 var formatPollData = function(poll)
			 {
			 	var pollData = [];
			 	var colorLength = chartColors.length;

			 	poll.responses.forEach(function(element, index) {

			 		var i = null;
			 		if(index > colorLength) {
			 			i = index - colorLength % colorLength;
			 		} else {
			 			i = index;
			 		}

					pollData.push({
						value: element.count,
						color: chartColors[i],
						label: element.choice

					});
				});

				return pollData;
			 };

			 var resetCanvas = function()
			 {
				  $('#pollResults').remove(); // this is my <canvas> element
				  $('#pollContainer').append('<canvas width="400" height="400" id="pollResults"><canvas>');
				  // canvas = document.querySelector('#pollResults');
				  ctx = $("#pollResults").get(0).getContext("2d");
				  // ctx.canvas.width = $('#graph').width(); // resize to parent width
				  // ctx.canvas.height = $('#graph').height(); // resize to parent height

				  // var x = canvas.width/2;
				  // var y = canvas.height/2;
				  // ctx.font = '10pt Verdana';
				  // ctx.textAlign = 'center';
				  // ctx.fillText('This text is centered on the canvas', x, y);
			};

		</script>
	</body>
</html>